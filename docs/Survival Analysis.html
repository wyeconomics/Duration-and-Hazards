<!DOCTYPE html>
<html lang="en"><head>
<script src="Survival Analysis_files/libs/clipboard/clipboard.min.js"></script>
<script src="Survival Analysis_files/libs/quarto-html/tabby.min.js"></script>
<script src="Survival Analysis_files/libs/quarto-html/popper.min.js"></script>
<script src="Survival Analysis_files/libs/quarto-html/tippy.umd.min.js"></script>
<link href="Survival Analysis_files/libs/quarto-html/tippy.css" rel="stylesheet">
<link href="Survival Analysis_files/libs/quarto-html/light-border.css" rel="stylesheet">
<link href="Survival Analysis_files/libs/quarto-html/quarto-syntax-highlighting-549806ee2085284f45b00abea8c6df48.css" rel="stylesheet" id="quarto-text-highlighting-styles"><meta charset="utf-8">
  <meta name="generator" content="quarto-1.6.40">

  <meta name="author" content="Wooyong Park">
  <title>Survival Analysis and Hazard Models</title>
  <meta name="apple-mobile-web-app-capable" content="yes">
  <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, minimal-ui">
  <link rel="stylesheet" href="Survival Analysis_files/libs/revealjs/dist/reset.css">
  <link rel="stylesheet" href="Survival Analysis_files/libs/revealjs/dist/reveal.css">
  <style>
    code{white-space: pre-wrap;}
    span.smallcaps{font-variant: small-caps;}
    div.columns{display: flex; gap: min(4vw, 1.5em);}
    div.column{flex: auto; overflow-x: auto;}
    div.hanging-indent{margin-left: 1.5em; text-indent: -1.5em;}
    ul.task-list{list-style: none;}
    ul.task-list li input[type="checkbox"] {
      width: 0.8em;
      margin: 0 0.8em 0.2em -1em; /* quarto-specific, see https://github.com/quarto-dev/quarto-cli/issues/4556 */ 
      vertical-align: middle;
    }
    /* CSS for syntax highlighting */
    pre > code.sourceCode { white-space: pre; position: relative; }
    pre > code.sourceCode > span { line-height: 1.25; }
    pre > code.sourceCode > span:empty { height: 1.2em; }
    .sourceCode { overflow: visible; }
    code.sourceCode > span { color: inherit; text-decoration: inherit; }
    div.sourceCode { margin: 1em 0; }
    pre.sourceCode { margin: 0; }
    @media screen {
    div.sourceCode { overflow: auto; }
    }
    @media print {
    pre > code.sourceCode { white-space: pre-wrap; }
    pre > code.sourceCode > span { display: inline-block; text-indent: -5em; padding-left: 5em; }
    }
    pre.numberSource code
      { counter-reset: source-line 0; }
    pre.numberSource code > span
      { position: relative; left: -4em; counter-increment: source-line; }
    pre.numberSource code > span > a:first-child::before
      { content: counter(source-line);
        position: relative; left: -1em; text-align: right; vertical-align: baseline;
        border: none; display: inline-block;
        -webkit-touch-callout: none; -webkit-user-select: none;
        -khtml-user-select: none; -moz-user-select: none;
        -ms-user-select: none; user-select: none;
        padding: 0 4px; width: 4em;
        color: #aaaaaa;
      }
    pre.numberSource { margin-left: 3em; border-left: 1px solid #aaaaaa;  padding-left: 4px; }
    div.sourceCode
      { color: #003b4f; background-color: #f1f3f5; }
    @media screen {
    pre > code.sourceCode > span > a:first-child::before { text-decoration: underline; }
    }
    code span { color: #003b4f; } /* Normal */
    code span.al { color: #ad0000; } /* Alert */
    code span.an { color: #5e5e5e; } /* Annotation */
    code span.at { color: #657422; } /* Attribute */
    code span.bn { color: #ad0000; } /* BaseN */
    code span.bu { } /* BuiltIn */
    code span.cf { color: #003b4f; font-weight: bold; } /* ControlFlow */
    code span.ch { color: #20794d; } /* Char */
    code span.cn { color: #8f5902; } /* Constant */
    code span.co { color: #5e5e5e; } /* Comment */
    code span.cv { color: #5e5e5e; font-style: italic; } /* CommentVar */
    code span.do { color: #5e5e5e; font-style: italic; } /* Documentation */
    code span.dt { color: #ad0000; } /* DataType */
    code span.dv { color: #ad0000; } /* DecVal */
    code span.er { color: #ad0000; } /* Error */
    code span.ex { } /* Extension */
    code span.fl { color: #ad0000; } /* Float */
    code span.fu { color: #4758ab; } /* Function */
    code span.im { color: #00769e; } /* Import */
    code span.in { color: #5e5e5e; } /* Information */
    code span.kw { color: #003b4f; font-weight: bold; } /* Keyword */
    code span.op { color: #5e5e5e; } /* Operator */
    code span.ot { color: #003b4f; } /* Other */
    code span.pp { color: #ad0000; } /* Preprocessor */
    code span.sc { color: #5e5e5e; } /* SpecialChar */
    code span.ss { color: #20794d; } /* SpecialString */
    code span.st { color: #20794d; } /* String */
    code span.va { color: #111111; } /* Variable */
    code span.vs { color: #20794d; } /* VerbatimString */
    code span.wa { color: #5e5e5e; font-style: italic; } /* Warning */
  </style>
  <link rel="stylesheet" href="Survival Analysis_files/libs/revealjs/dist/theme/quarto-367017fa2871343a8466c6f0f2630bc9.css">
  <link rel="stylesheet" href="styles_survival_analysis.css">
  <link href="Survival Analysis_files/libs/revealjs/plugin/quarto-line-highlight/line-highlight.css" rel="stylesheet">
  <link href="Survival Analysis_files/libs/revealjs/plugin/reveal-menu/menu.css" rel="stylesheet">
  <link href="Survival Analysis_files/libs/revealjs/plugin/reveal-menu/quarto-menu.css" rel="stylesheet">
  <link href="Survival Analysis_files/libs/revealjs/plugin/quarto-support/footer.css" rel="stylesheet">
  <style type="text/css">
    .reveal div.sourceCode {
      margin: 0;
      overflow: auto;
    }
    .reveal div.hanging-indent {
      margin-left: 1em;
      text-indent: -1em;
    }
    .reveal .slide:not(.center) {
      height: 100%;
    }
    .reveal .slide.scrollable {
      overflow-y: auto;
    }
    .reveal .footnotes {
      height: 100%;
      overflow-y: auto;
    }
    .reveal .slide .absolute {
      position: absolute;
      display: block;
    }
    .reveal .footnotes ol {
      counter-reset: ol;
      list-style-type: none; 
      margin-left: 0;
    }
    .reveal .footnotes ol li:before {
      counter-increment: ol;
      content: counter(ol) ". "; 
    }
    .reveal .footnotes ol li > p:first-child {
      display: inline-block;
    }
    .reveal .slide ul,
    .reveal .slide ol {
      margin-bottom: 0.5em;
    }
    .reveal .slide ul li,
    .reveal .slide ol li {
      margin-top: 0.4em;
      margin-bottom: 0.2em;
    }
    .reveal .slide ul[role="tablist"] li {
      margin-bottom: 0;
    }
    .reveal .slide ul li > *:first-child,
    .reveal .slide ol li > *:first-child {
      margin-block-start: 0;
    }
    .reveal .slide ul li > *:last-child,
    .reveal .slide ol li > *:last-child {
      margin-block-end: 0;
    }
    .reveal .slide .columns:nth-child(3) {
      margin-block-start: 0.8em;
    }
    .reveal blockquote {
      box-shadow: none;
    }
    .reveal .tippy-content>* {
      margin-top: 0.2em;
      margin-bottom: 0.7em;
    }
    .reveal .tippy-content>*:last-child {
      margin-bottom: 0.2em;
    }
    .reveal .slide > img.stretch.quarto-figure-center,
    .reveal .slide > img.r-stretch.quarto-figure-center {
      display: block;
      margin-left: auto;
      margin-right: auto; 
    }
    .reveal .slide > img.stretch.quarto-figure-left,
    .reveal .slide > img.r-stretch.quarto-figure-left  {
      display: block;
      margin-left: 0;
      margin-right: auto; 
    }
    .reveal .slide > img.stretch.quarto-figure-right,
    .reveal .slide > img.r-stretch.quarto-figure-right  {
      display: block;
      margin-left: auto;
      margin-right: 0; 
    }
  </style>
</head>
<body class="quarto-light">
  <div class="reveal">
    <div class="slides">

<section id="title-slide" data-background-image="images/main.jpg" class="quarto-title-block center">
  <h1 class="title">Survival Analysis and Hazard Models</h1>

<div class="quarto-title-authors">
<div class="quarto-title-author">
<div class="quarto-title-author-name">
Wooyong Park 
</div>
</div>
</div>

</section>
<section>
<section id="hazard-model" class="title-slide slide level1 center">
<h1>Hazard Model</h1>

</section>
<section id="introduction-to-hazard-models" class="slide level2">
<h2>Introduction to hazard models</h2>
<h3 id="hazard-models-are-better-than-the-traditional-regression-approach.">Hazard models are better than the traditional regression approach.</h3>
<p style="text-align: justify;">
</p><p>The traditional regression approach specifies a probability distribution for the duration time and fits it using data. The hazard approach, on the other hand, determines the probability of the outcome as a sequence of simpler conditional events.</p>
(Conditional sequential probabilities vs Unconditional direct probability distribution)
<p></p>
<p><br></p>
<h3 id="model-intuition">Model Intuition</h3>
<ul>
<li>Let <span class="math inline">\(\lambda = \lambda(X_i, t)\)</span> denote the probability of a certain spell being terminated.</li>
<li>Such probability of adoption/termination would typically be affected by individual characteristics(<span class="math inline">\(X_i\)</span>) and the duration of the spell(<span class="math inline">\(t\)</span>).</li>
<li>e.g.&nbsp;Probability of the spell being terminated in exactly 5 weeks: <span class="math inline">\(\left(1-\lambda(X_i,t)\right)^4 \cdot \lambda(X_i,t)\)</span></li>
</ul>
</section>
<section id="hazard-functions" class="slide level2">
<h2>Hazard Functions</h2>
<h3 id="hazard-function">Hazard Function</h3>
<p><span class="math display">\[\lambda(u) = \frac{P(u &lt; t \leq u+\delta u|t&gt;u)}{\delta u}\]</span> <strong>Meaning)</strong> Given that the spell wasn’t lifted by <span class="math inline">\(t = u\)</span>, the probability of the spell being lifted in <span class="math inline">\(\delta u\)</span> divided by the interval, <span class="math inline">\(\delta u\)</span>.</p>
</section>
<section id="hazard-functions-1" class="slide level2">
<h2>Hazard Functions</h2>
<h3 id="classical-distributionunconditional-distribution">Classical Distribution(Unconditional Distribution)</h3>
<p>Note that <span class="math inline">\(P(u\leq t)\)</span> is the CDF of the time from the beginning of the spell to the termination of the spell. Denote it by <span class="math inline">\(F(t)\)</span>. Then,</p>
<p><span class="math display">\[\begin{align}
\lambda(u) &amp;= \frac{P(u &lt; t \leq u+\delta u|t&gt;u)}{\delta u}\\
&amp;=\frac{P(t \leq u+\delta u) - P(t \leq u)}{\delta u \times P(t&gt;u)}\\
&amp;=\frac{1}{1-F(u)}\cdot\frac{F(u+\delta u)-F(u)}{\delta u} \stackrel{\delta u \to 0^{+}}{=}\frac{f(u)}{1-F(u)}
\end{align}\]</span></p>
<p><br></p>
<h3 id="relationship-between-hazard-functions-and-classical-distribution">Relationship between hazard functions and classical distribution</h3>
<p><a href="https://econpapers.repec.org/article/aeajeclit/v_3a26_3ay_3a1988_3ai_3a2_3ap_3a646-79.htm">Kiefer(1988)</a> states that every hazard function has an exact mathematical equivalent in terms of an unconditional probability distribution.<br>
By solving the differential equation,</p>
<p><span class="math display">\[f(u) = \lambda(u)\cdot exp\left[-\int_0^u \lambda(s)ds \right]\]</span></p>
</section>
<section id="survivor-function" class="slide level2">
<h2>Survivor Function</h2>
<p>The survivor function is defined as <span class="math inline">\(S(u) = 1-F(u)\)</span>.<br>
(i.e.&nbsp;the probability of spell being sustained until <span class="math inline">\(t=u\)</span>)<br>
Thus,</p>
<p><span class="math display">\[\begin{align}
\lambda(u) &amp;= \frac{f(u)}{1-F(u)}\\
&amp;= \frac{f(u)}{S(u)} = \frac{dF/du}{S(u)}\\
&amp;= \frac{-dS/du}{S(u)} = -\frac{dlnS(u)}{du}
\end{align}\]</span> Here, we can think of the survivor function as the <em>endurance probability</em> of a spell.</p>
<p><br></p>
<p><strong>RMK)</strong> Notice that if we could consistently estimate <span class="math inline">\(S(u)\)</span>, we can also consistently estimate <span class="math inline">\(\lambda(u)\)</span> given that differentiability and continuity of the derivative are guaranteed.</p>
</section>
<section id="parametric-hazard" class="slide level2">
<h2>Parametric Hazard</h2>
<h3 id="parametric-vs-nonparametric">Parametric vs Nonparametric</h3>
<ul>
<li>Parametric Hazard: Specifies the functional form of hazard before estimation</li>
<li>Nonparametric/Semiparametric Hazard: does not specify the hazard function form</li>
</ul>
<p><br></p>
<h3 id="constant-hazard">1. Constant Hazard</h3>
<ul>
<li>definition: <span class="math inline">\(\lambda(u) = \lambda_0\)</span> for all <span class="math inline">\(u&gt;0\)</span>.</li>
<li>unconditional pdf: <span class="math inline">\(f(u) = \lambda_0 exp\left[-\lambda_0 u\right]\)</span><br>
<span class="math inline">\(\to\)</span> exponential distribution with rate parameter <span class="math inline">\(\lambda_0\)</span></li>
</ul>
<p><br></p>
<p><strong>RMK)</strong> Notice that rate parameters describe the frequency or intensity of a random event in a unit time, which is equivalent to how we defined the hazard function itself.</p>
</section>
<section id="parametric-hazard-1" class="slide level2">
<h2>Parametric Hazard</h2>
<h3 id="weibull-distribution">2. Weibull Distribution</h3>
<p>Weibull distribution permits a <strong>monotonically increasing/decreasing</strong> hazard function, which either describes the “snowballing” effect or the “inerital” effect. Weibull survival functions are determined by two parameters: <span class="math inline">\(\alpha\)</span> and <span class="math inline">\(\sigma\)</span>.</p>
<ul>
<li>definition: <span class="math inline">\(\lambda(u) = \lambda(u) = \sigma \alpha (\sigma u)^{\alpha-1}\)</span> s.t. <span class="math inline">\(\sigma&gt;0\)</span> and <span class="math inline">\(\alpha&gt;0\)</span></li>
<li>unconditional pdf: <span class="math inline">\(f(u) = \sigma \alpha (\sigma u)^{\alpha-1}(1-\sigma u)\)</span></li>
<li>Monotone Increasing(<span class="math inline">\(\alpha&gt;1\)</span>), Monotone Decreasing(<span class="math inline">\(\alpha&lt;1\)</span>), Constant Hazard(<span class="math inline">\(\alpha = 1\)</span>)</li>
</ul>
<p><br></p>
<h3 id="log-normal-distribution">3. Log-Normal Distribution</h3>
<p>The log-normal model assumes that the log of a survival time follows a normal distribution. Such model allows the hazard to be non-monotonic.</p>
</section>
<section id="nonparametric-hazard" class="slide level2">
<h2>Nonparametric Hazard</h2>
<p style="text-align: justify;">
The problem with parametric methods is that under misspecified models(i.e.&nbsp;misspecified functional form of the hazard), the estimator is inconsistent of the actual hazard. Also it is often the case that the underlying model is difficult to specify. In such cases, we can rely on nonparametric hazard estimations.
</p>
<p><br></p>
<h3 id="cox-ph-model">Cox PH Model</h3>
<p style="text-align: justify;">
Among multiple nonparametric approaches, we only cover <strong>the Cox proportional-hazards model</strong>. <a href="https://www.jstor.org/stable/2985181">Cox (1972)</a> proposes a model that doesn’t require the distribution of survival durations to be known, at the cost of not estimating the hazard function itself.
</p>
<p style="text-align: justify;">
However, it is actually a <em>semi-parametric approach</em> in that it assumes a functional form in the regression on exogenous variables, which will be discussed shortly.
</p>
</section></section>
<section>
<section id="incorporation-of-exogenous-variables" class="title-slide slide level1 center">
<h1>Incorporation of Exogenous Variables</h1>

</section>
<section id="cox-ph-model-1" class="slide level2">
<h2>Cox PH Model</h2>
From now on, we denote the hazard function <span class="math inline">\(\lambda(u)\)</span> by <span class="math inline">\(h(t)\)</span> instead.
<div style="margin-top:0.5em;">

</div>
<p><span class="math display">\[ h_i(t) = h_0(t)exp\left[\beta_1X_{i1} +\cdots +\beta_kX_{ik}\right]\]</span></p>
<ul>
<li><p><span class="math inline">\(h_0(t)\)</span><br>
: the baseline hazard <span class="math inline">\(\to\)</span> doesn’t require functional form</p></li>
<li><p><span class="math inline">\(exp(\sum_{j=1}^k\beta_jX_{ij})\)</span><br>
: effects of covariates <span class="math inline">\(\to\)</span> specifying the functional form</p></li>
</ul>
<p><br></p>
<h3 id="regression-coefficient">Regression Coefficient</h3>
<p><span class="math display">\[\log h_i(t) = \log h_0(t) + \beta_1X_{i1} + \cdots + \beta_kX_{ik}\]</span></p>
<p><span class="math inline">\(\beta_j = \frac{\partial \log h_i(t)}{\partial X_{ij}}\)</span>, which means that the regression coefficient is the partial derivative of the log-hazard w.r.t. the covariate.</p>
<p>(Equivalently, <span class="math inline">\(\beta_j\)</span> denotes the percentage change of the hazard w.r.t. the unit change of the covariate)</p>
</section>
<section id="cox-ph-model-2" class="slide level2">
<h2>Cox PH Model</h2>
<p><span class="math display">\[ h_i(t) = h_0(t)exp\left[\beta_1X_{i1} +\cdots +\beta_kX_{ik}\right]\]</span></p>
<ul>
<li><p><span class="math inline">\(h_0(t)\)</span><br>
: the baseline hazard <span class="math inline">\(\to\)</span> doesn’t require functional form</p></li>
<li><p><span class="math inline">\(exp(\sum_{j=1}^k\beta_jX_{ij})\)</span><br>
: effects of covariates <span class="math inline">\(\to\)</span> specifying the functional form</p></li>
</ul>
<h3 id="hazard-ratios">Hazard Ratios</h3>
<p>We show two different definitions of hazard ratios depending on the context, although they are closely related to each other.</p>
<ol type="1">
<li><span class="math inline">\(exp(\beta_j)\)</span> : the exponential transformation of the coefficient</li>
<li><span class="math inline">\(\frac{\text{hazard in group A}}{\text{hazard in group B}} = e^{(X_{iA}-X_{iB})'\beta_i}\)</span> : hazard ratio between two groups</li>
</ol>
<p><strong>RMK)</strong> The PH model assumes that this ratio is constant, and one group’s (or individual’s) hazard is proportional and time-independent to the other.</p>
</section>
<section id="proportionality-assumptionph-model" class="slide level2">
<h2>Proportionality Assumption(PH Model)</h2>
<p style="text-align: justify;">
The Cox PH model assumes that the hazard ratio is constant. Suppose there are two individuals <span class="math inline">\(p\)</span> and <span class="math inline">\(q\)</span>. Then,
</p>
<p><span class="math display">\[\begin{align}
\begin{cases}
h_p(t) = h_0(t)e^{X_{p}'\beta}\\
h_q(t) = h_0(t)e^{X_{q}'\beta}
\end{cases}
\end{align}\]</span></p>
<p>which implies</p>
<span class="math display">\[\begin{align}
\text{hazard ratio} = exp\left[(X_p-X_q)'\beta\right]
\end{align}\]</span>
<p style="text-align: justify;">
that the hazard ratio is independent of the baseline hazard and time. Equivalently, the log-hazard ratio(<span class="math inline">\(\log h_p(t) - \log h_q(t)\)</span>) is also constant.
</p>
</section>
<section id="cox-ph-model-3" class="slide level2">
<h2>Cox PH Model</h2>
<p><span class="math display">\[ h_i(t) = h_0(t)exp\left[\beta_1X_{i1} +\cdots +\beta_kX_{ik}\right]\]</span></p>
<ul>
<li><p><span class="math inline">\(h_0(t)\)</span><br>
: the baseline hazard <span class="math inline">\(\to\)</span> doesn’t require functional form</p></li>
<li><p><span class="math inline">\(exp(\sum_{j=1}^k\beta_jX_{ij})\)</span><br>
: effects of covariates <span class="math inline">\(\to\)</span> specifying the functional form</p></li>
</ul>
<h3 id="limitations">Limitations</h3>
<ol type="1">
<li>Proportionality might not always be satisfied. In this case we adhere to the nonproportional Cox model.</li>
<li>cannot predict the survival time itself, nor can it provide the hazard function.</li>
</ol>
</section>
<section id="estimation" class="slide level2">
<h2>Estimation</h2>
<p style="text-align: justify;">
We estimate the coefficients through <strong>partial likelihood estimation(ple)</strong>. PLE is equivalent to MLE, but we only consider the likelihoods of the data that experienced the event.
</p>
<p style="text-align: justify;">
In the data of observations with their spell ended, we are seeing that particular observation’s spell ended at a given time while other else’s spells could have ended at that time also. The likelihood could be described by the next question:
</p>
<p style="text-align: justify;">
“Given that the spell lift happened at time <span class="math inline">\(u\)</span>, what’s the probability that it happened to the individual <span class="math inline">\(A\)</span>?”
</p>
<p><span class="math display">\[\begin{align}
L_A &amp;= \frac{h_A(u)}{\sum_{i\text{'s spell not ended before u}}h_i(u)}\\
&amp;=\frac{h_0(t)e^{\beta_1X_{A1}+\cdots+\beta_kX_{Ak}}}{h_0(t)(e^{\beta_1X_{A1}+\cdots+\beta_kX_{Ak}} +\sum_{i(\neq A)\text{'s spell not ended before u}}e^{\beta_1X_{i1} +\cdots + \beta_kX_{ik}})}\\
&amp;=\frac{e^{\beta_1X_{A1}+\cdots+\beta_kX_{Ak}}}{e^{\beta_1X_{A1}+\cdots+\beta_kX_{Ak}} +\sum_{i(\neq A)\text{'s spell not ended before u}}e^{\beta_1X_{i1} +\cdots + \beta_kX_{ik}}}
\end{align}\]</span></p>
</section>
<section id="censoring-issues" class="slide level2">
<h2>Censoring Issues</h2>
<p style="text-align: justify;">
Censoring issues are what could happen in the data we hold. It indicates the event(lift of the spell) not being observed for some individuals within the study time period. We call such individuals <em>censored observations</em>. This problem arises may arise in three possible ways:
</p>
<div class="columns">
<div class="column" style="width:30%;">
<ol type="1">
<li>Left Censoring</li>
<li>Right Censoring</li>
<li>Full Censoring</li>
</ol>
</div><div class="column" style="width:70%;">
<div class="cell">
<div class="cell-output-display">
<div>
<figure>
<p><img data-src="Survival-Analysis_files/figure-revealjs/unnamed-chunk-1-1.png" width="960"></p>
</figure>
</div>
</div>
</div>
</div></div>
<p>However, note that in the case of <em>right censoring</em>, it doesn’t dissipate all valuable information, but sheds light on the information of survival probability for a given duration.</p>
</section></section>
<section>
<section id="r-survival-analysis" class="title-slide slide level1 center">
<h1>R Survival Analysis</h1>

</section>
<section id="setting-up" class="slide level2">
<h2>Setting up</h2>
<div class="cell">
<div class="sourceCode cell-code" id="cb1"><pre class="sourceCode numberSource r number-lines code-with-copy"><code class="sourceCode r"><span id="cb1-1"><a href=""></a><span class="fu">library</span>(tidyverse)</span>
<span id="cb1-2"><a href=""></a><span class="fu">library</span>(survival)      <span class="co"># for survival analysis</span></span>
<span id="cb1-3"><a href=""></a><span class="fu">library</span>(survminer)     <span class="co"># for visualization of the analysis</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>All the codes and exercise materials are from <a href="https://www.sthda.com/english/wiki/cox-proportional-hazards-model">STHDA</a>.</p>
</section>
<section id="cox-ph-model-4" class="slide level2">
<h2>Cox PH Model</h2>
<h3 id="coxph"><code>coxph</code></h3>
<p><code>coxph(formula, data, ties)</code> helps create the Cox proportional hazard regressions in R.</p>
<ul>
<li><code>formula</code>: Linear model with a survival object as the response variable. Survival object is created using the function <code>Surv()</code> as follow: <code>Surv(time, event)</code>.</li>
<li><code>data</code>: the data</li>
<li><code>ties</code>: used to specify how to handle <strong>ties</strong>(the default option <code>efron</code> is usually the most preferred)</li>
</ul>
<h3 id="surv"><code>Surv</code></h3>
<p><code>Surv(time, event)</code></p>
<ul>
<li><code>time</code>: Follow up time</li>
<li><code>event</code>: normally 0=alive, 1=dead</li>
</ul>
</section>
<section id="cox-ph-model-5" class="slide level2">
<h2>Cox PH Model</h2>
</section>
<section id="exerciselung-cancer" class="slide level2">
<h2>Exercise(Lung Cancer)</h2>
<div class="cell">
<div class="sourceCode cell-code" id="cb2"><pre class="sourceCode numberSource r number-lines code-with-copy"><code class="sourceCode r"><span id="cb2-1"><a href=""></a><span class="fu">data</span>(<span class="st">'lung'</span>)</span>
<span id="cb2-2"><a href=""></a><span class="fu">head</span>(lung)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>  inst time status age sex ph.ecog ph.karno pat.karno meal.cal wt.loss
1    3  306      2  74   1       1       90       100     1175      NA
2    3  455      2  68   1       0       90        90     1225      15
3    3 1010      1  56   1       0       90        90       NA      15
4    5  210      2  57   1       1       90        60     1150      11
5    1  883      2  60   1       0      100        90       NA       0
6   12 1022      1  74   1       1       50        80      513       0</code></pre>
</div>
</div>
<p><br></p>
<ul>
<li>time: Survival time in days</li>
<li>status: censoring status 1=censored, 2=dead</li>
<li>sex: Male=1 Female=2</li>
</ul>
</section>
<section id="univariate-cox-regression" class="slide level2">
<h2>Univariate Cox Regression</h2>
<div class="cell">
<div class="sourceCode cell-code" id="cb4"><pre class="sourceCode numberSource r number-lines code-with-copy"><code class="sourceCode r"><span id="cb4-1"><a href=""></a>res.cox <span class="ot">&lt;-</span> <span class="fu">coxph</span>(<span class="fu">Surv</span>(time, status) <span class="sc">~</span> sex, <span class="at">data =</span> lung)</span>
<span id="cb4-2"><a href=""></a><span class="fu">summary</span>(res.cox)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>Call:
coxph(formula = Surv(time, status) ~ sex, data = lung)

  n= 228, number of events= 165 

       coef exp(coef) se(coef)      z Pr(&gt;|z|)   
sex -0.5310    0.5880   0.1672 -3.176  0.00149 **
---
Signif. codes:  0 '***' 0.001 '**' 0.01 '*' 0.05 '.' 0.1 ' ' 1

    exp(coef) exp(-coef) lower .95 upper .95
sex     0.588      1.701    0.4237     0.816

Concordance= 0.579  (se = 0.021 )
Likelihood ratio test= 10.63  on 1 df,   p=0.001
Wald test            = 10.09  on 1 df,   p=0.001
Score (logrank) test = 10.33  on 1 df,   p=0.001</code></pre>
</div>
</div>
<p><br></p>
<ol type="1">
<li>Statistical Significance: determined by Wald-type tests on the likelihood induced regression coefficients</li>
<li>Regression Coefficients: percentage change of the hazard w.r.t. the unit change in the explanatory variable.</li>
<li><code>exp(coef)</code>: hazard ratios</li>
</ol>
</section>
<section id="multivariate-cox-regression" class="slide level2">
<h2>Multivariate Cox Regression</h2>
<div class="cell">
<div class="sourceCode cell-code" id="cb6"><pre class="sourceCode numberSource r number-lines code-with-copy"><code class="sourceCode r"><span id="cb6-1"><a href=""></a>res.cox <span class="ot">&lt;-</span> <span class="fu">coxph</span>(<span class="fu">Surv</span>(time, status) <span class="sc">~</span> age <span class="sc">+</span> sex <span class="sc">+</span> ph.ecog, <span class="at">data =</span>  lung)</span>
<span id="cb6-2"><a href=""></a><span class="fu">summary</span>(res.cox)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>Call:
coxph(formula = Surv(time, status) ~ age + sex + ph.ecog, data = lung)

  n= 227, number of events= 164 
   (1 observation deleted due to missingness)

             coef exp(coef)  se(coef)      z Pr(&gt;|z|)    
age      0.011067  1.011128  0.009267  1.194 0.232416    
sex     -0.552612  0.575445  0.167739 -3.294 0.000986 ***
ph.ecog  0.463728  1.589991  0.113577  4.083 4.45e-05 ***
---
Signif. codes:  0 '***' 0.001 '**' 0.01 '*' 0.05 '.' 0.1 ' ' 1

        exp(coef) exp(-coef) lower .95 upper .95
age        1.0111     0.9890    0.9929    1.0297
sex        0.5754     1.7378    0.4142    0.7994
ph.ecog    1.5900     0.6289    1.2727    1.9864

Concordance= 0.637  (se = 0.025 )
Likelihood ratio test= 30.5  on 3 df,   p=1e-06
Wald test            = 29.93  on 3 df,   p=1e-06
Score (logrank) test = 30.5  on 3 df,   p=1e-06</code></pre>
</div>
</div>
</section>
<section id="vizualizing-survival-probabilities" class="slide level2">
<h2>Vizualizing Survival Probabilities</h2>
<p>Recall that <span class="math inline">\(h(u) = -\frac{dlnS(u)}{du}\)</span>, which implies</p>
<p><span class="math display">\[\begin{align}
S(t) &amp;= e^{-\int_0^th(u)du}\\
&amp;=e^{-\int_0^th_0(u)exp(X'\beta)du}\\
&amp;=e^{-\int_0^th_0(u)du \cdot exp(X'\beta)}\\
&amp;= S_0(t)^{exp(X'\beta)}
\end{align}\]</span></p>
<p>To estimate such survival probabilities and plot them, we first need the baseline hazard and the following baseline survivability via other methods.</p>
</section>
<section id="visualizing-survival-probabilities" class="slide level2">
<h2>Visualizing Survival Probabilities</h2>
<p>In the <code>survival</code> package, the baseline survival and hazard are first estimated by the <strong>Breslow estimator</strong>.</p>
<h3 id="base-hazard">Base Hazard</h3>
<div class="cell">
<div class="sourceCode cell-code" id="cb8"><pre class="sourceCode numberSource r number-lines code-with-copy"><code class="sourceCode r"><span id="cb8-1"><a href=""></a>base_hazard <span class="ot">&lt;-</span> <span class="fu">basehaz</span>(res.cox)</span>
<span id="cb8-2"><a href=""></a><span class="fu">head</span>(base_hazard)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>       hazard time
1 0.003963022    5
2 0.015948084   11
3 0.019992796   12
4 0.028188936   13
5 0.032333588   15
6 0.036493082   26</code></pre>
</div>
</div>
<h3 id="base-survivability">Base Survivability</h3>
<div class="cell" data-layout-align="center">
<div class="sourceCode cell-code" id="cb10"><pre class="sourceCode numberSource r number-lines code-with-copy"><code class="sourceCode r"><span id="cb10-1"><a href=""></a><span class="fu">ggsurvplot</span>(<span class="fu">survfit</span>(res.cox), <span class="at">data =</span> lung, <span class="at">color =</span> <span class="st">'blue'</span>, <span class="at">ggtheme =</span> <span class="fu">theme_minimal</span>())</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>

</div>
<img data-src="Survival-Analysis_files/figure-revealjs/unnamed-chunk-7-1.png" class="quarto-figure quarto-figure-center r-stretch" width="768"></section>
<section id="visualizing-survival-probabilities-1" class="slide level2">
<h2>Visualizing Survival Probabilities</h2>
<h3 id="group-level-survivability">Group level Survivability</h3>
<div class="cell" data-layout-align="center">
<div class="sourceCode cell-code" id="cb11"><pre class="sourceCode numberSource r number-lines code-with-copy"><code class="sourceCode r"><span id="cb11-1"><a href=""></a><span class="co"># Create the new data  </span></span>
<span id="cb11-2"><a href=""></a>sex_df <span class="ot">&lt;-</span> <span class="fu">with</span>(lung,</span>
<span id="cb11-3"><a href=""></a>               <span class="fu">data.frame</span>(<span class="at">sex =</span> <span class="fu">c</span>(<span class="dv">1</span>, <span class="dv">2</span>), </span>
<span id="cb11-4"><a href=""></a>                          <span class="at">age =</span> <span class="fu">rep</span>(<span class="fu">mean</span>(age, <span class="at">na.rm =</span> <span class="cn">TRUE</span>), <span class="dv">2</span>),</span>
<span id="cb11-5"><a href=""></a>                          <span class="at">ph.ecog =</span> <span class="fu">c</span>(<span class="dv">1</span>, <span class="dv">1</span>)</span>
<span id="cb11-6"><a href=""></a>                          )</span>
<span id="cb11-7"><a href=""></a>               )</span>
<span id="cb11-8"><a href=""></a><span class="co"># Survival curves</span></span>
<span id="cb11-9"><a href=""></a>fit <span class="ot">&lt;-</span> <span class="fu">survfit</span>(res.cox, <span class="at">data =</span> lung, <span class="at">newdata =</span> sex_df)</span>
<span id="cb11-10"><a href=""></a></span>
<span id="cb11-11"><a href=""></a><span class="fu">ggsurvplot</span>(fit, <span class="at">conf.int =</span> <span class="cn">TRUE</span>, <span class="at">legend.labs=</span><span class="fu">c</span>(<span class="st">"Sex=1"</span>, <span class="st">"Sex=2"</span>),</span>
<span id="cb11-12"><a href=""></a>           <span class="at">ggtheme =</span> <span class="fu">theme_minimal</span>())</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>

</div>
<img data-src="Survival-Analysis_files/figure-revealjs/unnamed-chunk-8-1.png" class="quarto-figure quarto-figure-center r-stretch" width="1152">

</section></section>
    </div>
  <div class="quarto-auto-generated-content" style="display: none;">
<div class="footer footer-default">

</div>
</div></div>

  <script>window.backupDefine = window.define; window.define = undefined;</script>
  <script src="Survival Analysis_files/libs/revealjs/dist/reveal.js"></script>
  <!-- reveal.js plugins -->
  <script src="Survival Analysis_files/libs/revealjs/plugin/quarto-line-highlight/line-highlight.js"></script>
  <script src="Survival Analysis_files/libs/revealjs/plugin/pdf-export/pdfexport.js"></script>
  <script src="Survival Analysis_files/libs/revealjs/plugin/reveal-menu/menu.js"></script>
  <script src="Survival Analysis_files/libs/revealjs/plugin/reveal-menu/quarto-menu.js"></script>
  <script src="Survival Analysis_files/libs/revealjs/plugin/quarto-support/support.js"></script>
  

  <script src="Survival Analysis_files/libs/revealjs/plugin/notes/notes.js"></script>
  <script src="Survival Analysis_files/libs/revealjs/plugin/search/search.js"></script>
  <script src="Survival Analysis_files/libs/revealjs/plugin/zoom/zoom.js"></script>
  <script src="Survival Analysis_files/libs/revealjs/plugin/math/math.js"></script>
  <script>window.define = window.backupDefine; window.backupDefine = undefined;</script>

  <script>

      // Full list of configuration options available at:
      // https://revealjs.com/config/
      Reveal.initialize({
'controlsAuto': true,
'previewLinksAuto': false,
'pdfSeparateFragments': false,
'autoAnimateEasing': "ease",
'autoAnimateDuration': 1,
'autoAnimateUnmatched': true,
'jumpToSlide': true,
'menu': {"side":"left","useTextContentForMissingTitles":true,"markers":false,"loadIcons":false,"custom":[{"title":"Tools","icon":"<i class=\"fas fa-gear\"></i>","content":"<ul class=\"slide-menu-items\">\n<li class=\"slide-tool-item active\" data-item=\"0\"><a href=\"#\" onclick=\"RevealMenuToolHandlers.fullscreen(event)\"><kbd>f</kbd> Fullscreen</a></li>\n<li class=\"slide-tool-item\" data-item=\"1\"><a href=\"#\" onclick=\"RevealMenuToolHandlers.speakerMode(event)\"><kbd>s</kbd> Speaker View</a></li>\n<li class=\"slide-tool-item\" data-item=\"2\"><a href=\"#\" onclick=\"RevealMenuToolHandlers.overview(event)\"><kbd>o</kbd> Slide Overview</a></li>\n<li class=\"slide-tool-item\" data-item=\"3\"><a href=\"#\" onclick=\"RevealMenuToolHandlers.togglePdfExport(event)\"><kbd>e</kbd> PDF Export Mode</a></li>\n<li class=\"slide-tool-item\" data-item=\"4\"><a href=\"#\" onclick=\"RevealMenuToolHandlers.toggleScrollView(event)\"><kbd>r</kbd> Scroll View Mode</a></li>\n<li class=\"slide-tool-item\" data-item=\"5\"><a href=\"#\" onclick=\"RevealMenuToolHandlers.keyboardHelp(event)\"><kbd>?</kbd> Keyboard Help</a></li>\n</ul>"}],"openButton":true},
'smaller': false,
 
        // Display controls in the bottom right corner
        controls: false,

        // Help the user learn the controls by providing hints, for example by
        // bouncing the down arrow when they first encounter a vertical slide
        controlsTutorial: false,

        // Determines where controls appear, "edges" or "bottom-right"
        controlsLayout: 'edges',

        // Visibility rule for backwards navigation arrows; "faded", "hidden"
        // or "visible"
        controlsBackArrows: 'faded',

        // Display a presentation progress bar
        progress: true,

        // Display the page number of the current slide
        slideNumber: false,

        // 'all', 'print', or 'speaker'
        showSlideNumber: 'all',

        // Add the current slide number to the URL hash so that reloading the
        // page/copying the URL will return you to the same slide
        hash: true,

        // Start with 1 for the hash rather than 0
        hashOneBasedIndex: false,

        // Flags if we should monitor the hash and change slides accordingly
        respondToHashChanges: true,

        // Push each slide change to the browser history
        history: true,

        // Enable keyboard shortcuts for navigation
        keyboard: true,

        // Enable the slide overview mode
        overview: true,

        // Disables the default reveal.js slide layout (scaling and centering)
        // so that you can use custom CSS layout
        disableLayout: false,

        // Vertical centering of slides
        center: false,

        // Enables touch navigation on devices with touch input
        touch: true,

        // Loop the presentation
        loop: false,

        // Change the presentation direction to be RTL
        rtl: false,

        // see https://revealjs.com/vertical-slides/#navigation-mode
        navigationMode: 'linear',

        // Randomizes the order of slides each time the presentation loads
        shuffle: false,

        // Turns fragments on and off globally
        fragments: true,

        // Flags whether to include the current fragment in the URL,
        // so that reloading brings you to the same fragment position
        fragmentInURL: false,

        // Flags if the presentation is running in an embedded mode,
        // i.e. contained within a limited portion of the screen
        embedded: false,

        // Flags if we should show a help overlay when the questionmark
        // key is pressed
        help: true,

        // Flags if it should be possible to pause the presentation (blackout)
        pause: true,

        // Flags if speaker notes should be visible to all viewers
        showNotes: false,

        // Global override for autoplaying embedded media (null/true/false)
        autoPlayMedia: null,

        // Global override for preloading lazy-loaded iframes (null/true/false)
        preloadIframes: null,

        // Number of milliseconds between automatically proceeding to the
        // next slide, disabled when set to 0, this value can be overwritten
        // by using a data-autoslide attribute on your slides
        autoSlide: 0,

        // Stop auto-sliding after user input
        autoSlideStoppable: true,

        // Use this method for navigation when auto-sliding
        autoSlideMethod: null,

        // Specify the average time in seconds that you think you will spend
        // presenting each slide. This is used to show a pacing timer in the
        // speaker view
        defaultTiming: null,

        // Enable slide navigation via mouse wheel
        mouseWheel: false,

        // The display mode that will be used to show slides
        display: 'block',

        // Hide cursor if inactive
        hideInactiveCursor: true,

        // Time before the cursor is hidden (in ms)
        hideCursorTime: 5000,

        // Opens links in an iframe preview overlay
        previewLinks: false,

        // Transition style (none/fade/slide/convex/concave/zoom)
        transition: 'none',

        // Transition speed (default/fast/slow)
        transitionSpeed: 'default',

        // Transition style for full page slide backgrounds
        // (none/fade/slide/convex/concave/zoom)
        backgroundTransition: 'none',

        // Number of slides away from the current that are visible
        viewDistance: 3,

        // Number of slides away from the current that are visible on mobile
        // devices. It is advisable to set this to a lower number than
        // viewDistance in order to save resources.
        mobileViewDistance: 2,

        // The "normal" size of the presentation, aspect ratio will be preserved
        // when the presentation is scaled to fit different resolutions. Can be
        // specified using percentage units.
        width: 1050,

        height: 700,

        // Factor of the display size that should remain empty around the content
        margin: 0.1,

        math: {
          mathjax: 'https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.9/MathJax.js',
          config: 'TeX-AMS_HTML-full',
          tex2jax: {
            inlineMath: [['\\(','\\)']],
            displayMath: [['\\[','\\]']],
            balanceBraces: true,
            processEscapes: false,
            processRefs: true,
            processEnvironments: true,
            preview: 'TeX',
            skipTags: ['script','noscript','style','textarea','pre','code'],
            ignoreClass: 'tex2jax_ignore',
            processClass: 'tex2jax_process'
          },
        },

        // reveal.js plugins
        plugins: [QuartoLineHighlight, PdfExport, RevealMenu, QuartoSupport,

          RevealMath,
          RevealNotes,
          RevealSearch,
          RevealZoom
        ]
      });
    </script>
    
    <script>
      // htmlwidgets need to know to resize themselves when slides are shown/hidden.
      // Fire the "slideenter" event (handled by htmlwidgets.js) when the current
      // slide changes (different for each slide format).
      (function () {
        // dispatch for htmlwidgets
        function fireSlideEnter() {
          const event = window.document.createEvent("Event");
          event.initEvent("slideenter", true, true);
          window.document.dispatchEvent(event);
        }

        function fireSlideChanged(previousSlide, currentSlide) {
          fireSlideEnter();

          // dispatch for shiny
          if (window.jQuery) {
            if (previousSlide) {
              window.jQuery(previousSlide).trigger("hidden");
            }
            if (currentSlide) {
              window.jQuery(currentSlide).trigger("shown");
            }
          }
        }

        // hookup for slidy
        if (window.w3c_slidy) {
          window.w3c_slidy.add_observer(function (slide_num) {
            // slide_num starts at position 1
            fireSlideChanged(null, w3c_slidy.slides[slide_num - 1]);
          });
        }

      })();
    </script>

    <script id="quarto-html-after-body" type="application/javascript">
    window.document.addEventListener("DOMContentLoaded", function (event) {
      const toggleBodyColorMode = (bsSheetEl) => {
        const mode = bsSheetEl.getAttribute("data-mode");
        const bodyEl = window.document.querySelector("body");
        if (mode === "dark") {
          bodyEl.classList.add("quarto-dark");
          bodyEl.classList.remove("quarto-light");
        } else {
          bodyEl.classList.add("quarto-light");
          bodyEl.classList.remove("quarto-dark");
        }
      }
      const toggleBodyColorPrimary = () => {
        const bsSheetEl = window.document.querySelector("link#quarto-bootstrap");
        if (bsSheetEl) {
          toggleBodyColorMode(bsSheetEl);
        }
      }
      toggleBodyColorPrimary();  
      const tabsets =  window.document.querySelectorAll(".panel-tabset-tabby")
      tabsets.forEach(function(tabset) {
        const tabby = new Tabby('#' + tabset.id);
      });
      const isCodeAnnotation = (el) => {
        for (const clz of el.classList) {
          if (clz.startsWith('code-annotation-')) {                     
            return true;
          }
        }
        return false;
      }
      const onCopySuccess = function(e) {
        // button target
        const button = e.trigger;
        // don't keep focus
        button.blur();
        // flash "checked"
        button.classList.add('code-copy-button-checked');
        var currentTitle = button.getAttribute("title");
        button.setAttribute("title", "Copied!");
        let tooltip;
        if (window.bootstrap) {
          button.setAttribute("data-bs-toggle", "tooltip");
          button.setAttribute("data-bs-placement", "left");
          button.setAttribute("data-bs-title", "Copied!");
          tooltip = new bootstrap.Tooltip(button, 
            { trigger: "manual", 
              customClass: "code-copy-button-tooltip",
              offset: [0, -8]});
          tooltip.show();    
        }
        setTimeout(function() {
          if (tooltip) {
            tooltip.hide();
            button.removeAttribute("data-bs-title");
            button.removeAttribute("data-bs-toggle");
            button.removeAttribute("data-bs-placement");
          }
          button.setAttribute("title", currentTitle);
          button.classList.remove('code-copy-button-checked');
        }, 1000);
        // clear code selection
        e.clearSelection();
      }
      const getTextToCopy = function(trigger) {
          const codeEl = trigger.previousElementSibling.cloneNode(true);
          for (const childEl of codeEl.children) {
            if (isCodeAnnotation(childEl)) {
              childEl.remove();
            }
          }
          return codeEl.innerText;
      }
      const clipboard = new window.ClipboardJS('.code-copy-button:not([data-in-quarto-modal])', {
        text: getTextToCopy
      });
      clipboard.on('success', onCopySuccess);
      if (window.document.getElementById('quarto-embedded-source-code-modal')) {
        const clipboardModal = new window.ClipboardJS('.code-copy-button[data-in-quarto-modal]', {
          text: getTextToCopy,
          container: window.document.getElementById('quarto-embedded-source-code-modal')
        });
        clipboardModal.on('success', onCopySuccess);
      }
        var localhostRegex = new RegExp(/^(?:http|https):\/\/localhost\:?[0-9]*\//);
        var mailtoRegex = new RegExp(/^mailto:/);
          var filterRegex = new RegExp('/' + window.location.host + '/');
        var isInternal = (href) => {
            return filterRegex.test(href) || localhostRegex.test(href) || mailtoRegex.test(href);
        }
        // Inspect non-navigation links and adorn them if external
     	var links = window.document.querySelectorAll('a[href]:not(.nav-link):not(.navbar-brand):not(.toc-action):not(.sidebar-link):not(.sidebar-item-toggle):not(.pagination-link):not(.no-external):not([aria-hidden]):not(.dropdown-item):not(.quarto-navigation-tool):not(.about-link)');
        for (var i=0; i<links.length; i++) {
          const link = links[i];
          if (!isInternal(link.href)) {
            // undo the damage that might have been done by quarto-nav.js in the case of
            // links that we want to consider external
            if (link.dataset.originalHref !== undefined) {
              link.href = link.dataset.originalHref;
            }
          }
        }
      function tippyHover(el, contentFn, onTriggerFn, onUntriggerFn) {
        const config = {
          allowHTML: true,
          maxWidth: 500,
          delay: 100,
          arrow: false,
          appendTo: function(el) {
              return el.closest('section.slide') || el.parentElement;
          },
          interactive: true,
          interactiveBorder: 10,
          theme: 'light-border',
          placement: 'bottom-start',
        };
        if (contentFn) {
          config.content = contentFn;
        }
        if (onTriggerFn) {
          config.onTrigger = onTriggerFn;
        }
        if (onUntriggerFn) {
          config.onUntrigger = onUntriggerFn;
        }
          config['offset'] = [0,0];
          config['maxWidth'] = 700;
        window.tippy(el, config); 
      }
      const noterefs = window.document.querySelectorAll('a[role="doc-noteref"]');
      for (var i=0; i<noterefs.length; i++) {
        const ref = noterefs[i];
        tippyHover(ref, function() {
          // use id or data attribute instead here
          let href = ref.getAttribute('data-footnote-href') || ref.getAttribute('href');
          try { href = new URL(href).hash; } catch {}
          const id = href.replace(/^#\/?/, "");
          const note = window.document.getElementById(id);
          if (note) {
            return note.innerHTML;
          } else {
            return "";
          }
        });
      }
      const findCites = (el) => {
        const parentEl = el.parentElement;
        if (parentEl) {
          const cites = parentEl.dataset.cites;
          if (cites) {
            return {
              el,
              cites: cites.split(' ')
            };
          } else {
            return findCites(el.parentElement)
          }
        } else {
          return undefined;
        }
      };
      var bibliorefs = window.document.querySelectorAll('a[role="doc-biblioref"]');
      for (var i=0; i<bibliorefs.length; i++) {
        const ref = bibliorefs[i];
        const citeInfo = findCites(ref);
        if (citeInfo) {
          tippyHover(citeInfo.el, function() {
            var popup = window.document.createElement('div');
            citeInfo.cites.forEach(function(cite) {
              var citeDiv = window.document.createElement('div');
              citeDiv.classList.add('hanging-indent');
              citeDiv.classList.add('csl-entry');
              var biblioDiv = window.document.getElementById('ref-' + cite);
              if (biblioDiv) {
                citeDiv.innerHTML = biblioDiv.innerHTML;
              }
              popup.appendChild(citeDiv);
            });
            return popup.innerHTML;
          });
        }
      }
    });
    </script>
    

</body></html>